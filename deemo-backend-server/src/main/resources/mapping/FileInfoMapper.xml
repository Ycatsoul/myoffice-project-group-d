<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.capgemini.cn.deemo.mapper.FileInfoMapper">

  <!-- 根据fileId获取文件详尽信息 -->
  <select id="getFile" parameterType="Long" resultType="com.capgemini.cn.deemo.data.domain.FileInfo">
    SELECT * FROM File WHERE fileId = #{fileId}
  </select>

  <!-- 获取文件列表 -->
  <select id="getFiles" resultType="com.capgemini.cn.deemo.data.domain.FileInfo">
    SELECT * FROM File WHERE isDeleted = 0
  </select>

  <!-- 获取已删除文件列表 -->
  <select id="getDeletedFiles" resultType="com.capgemini.cn.deemo.data.domain.FileInfo">
    SELECT * FROM File WHERE isDeleted = 1
  </select>

  <!-- 搜索文件 字段: 文件名 拥有者姓名 创建时间 -->
  <select id="searchFiles"
          parameterType="com.capgemini.cn.deemo.vo.request.FileInfoSearchVo"
          resultType="com.capgemini.cn.deemo.data.domain.FileInfo">
    SELECT *
    FROM File
    WHERE isDeleted = 0
        <if test="fileInfoSearchVo.fileName != null">
          AND fileName LIKE concat(concat('%', #{fileInfoSearchVo.fileName}), '%')
        </if>
        <if test="fileInfoSearchVo.createUserName != null">
          AND fileOwnerId IN (
              SELECT userId FROM User
              WHERE userName LIKE concat(concat('%', #{fileInfoSearchVo.createUserName}), '%')
          )
        </if>
        <if test="fileInfoSearchVo.startTime != null and fileInfoSearchVo.endTime != null">
          AND uploadTime BETWEEN #{fileInfoSearchVo.startTime} AND #{fileInfoSearchVo.endTime}
        </if>
  </select>

  <!-- 插入一条文件记录 -->
  <insert id="insertFile" parameterType="com.capgemini.cn.deemo.data.domain.FileInfo">
    INSERT INTO File (
      fileId,
      fileName,
      filePath,
      fileTypeId,
      fileOwnerId,
      remark,
      parentId
    ) VALUES (
      #{fileInfo.fileId},
      #{fileInfo.fileName},
      #{fileInfo.filePath},
      #{fileInfo.fileTypeId},
      #{fileInfo.fileOwnerId},
      #{fileInfo.remark},
      #{fileInfo.parentId}
    )
  </insert>

  <!-- 更新文件信息 可更新字段: 文件名 备注信息 -->
  <update id="updateFile" parameterType="com.capgemini.cn.deemo.vo.request.FileInfoEditVo">
    UPDATE File
    SET fileName = #{fileInfoEditVo.fileName}, remark = #{fileInfoEditVo.remark}
    WHERE fileId = #{fileInfoEditVo.fileId}
  </update>

  <!-- 根据fileId将文件放入回收站 -->
  <update id="putFilesToTrash" parameterType="java.util.List">
    UPDATE File SET isDeleted = 1 WHERE fileId IN #{fileIds}
  </update>

  <!-- 根据fileId从回收站中恢复文件 -->
  <update id="restoreFilesFromTrash" parameterType="java.util.List">
    UPDATE File SET isDeleted = 0 WHERE fileId IN #{fileIds}
  </update>

  <!-- 根据fileId从回收站中永久删除文件 -->
  <delete id="deleteFilesFromTrash" parameterType="java.util.List">
    DELETE FROM File WHERE fileId IN #{fileIds}
  </delete>
</mapper>